parameters:
  - name: fluentVersion
    type: string
    default: v8
  - name: storyPackageName
    type: string
    default: '@fluentui/vr-tests'
  - name: storyPackagePath
    type: string
    default: 'apps/vr-tests'
  - name: shouldbuildstorybookaddon
    type: boolean
    default: false

steps:
  - script: |
      echo REASON
      echo $(Build.Reason)
      echo SOURCE BRANCH
      echo $(Build.SourceBranch)

    displayName: yarn (install packages)

  - task: Bash@3
    inputs:
      filePath: yarn-ci.sh
    displayName: yarn (install packages)

  - script: |
      echo "Is PR build? ${{startsWith(github.ref, 'refs/pull/')}}"
      packageAffected=$(yarn --silent check:affected-package --packages @fluentui/vr-tests --pr=true
      if [[ $packageAffected == false ]]; then
        echo "Should skip screener"
      else
        echo "Should NOT skip screener"
      fi
    displayName: Should

  - script: |
      yarn workspace ${{ parameters.storyPackageName }} convert
    displayName: Convert screener component to storywright

  - ${{ if eq(parameters.shouldbuildstorybookaddon, 'true') }}:
      - script: |
          yarn build --to @fluentui/react-storybook-addon
        displayName: Build react-storybook-addon

  - script: |
      yarn workspace ${{ parameters.storyPackageName }} screener:build
    displayName: Build VR tests components package

  - script: |
      yarn workspace ${{ parameters.storyPackageName }} test:component --verbose
    displayName: 'Run VR tests'

  - script: |
      mkdir -p screenshots
      cp -rf ${{ parameters.storyPackagePath }}/dist/screenshots/*.png screenshots/
    displayName: Collate Artifacts

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: 'screenshots'
      ArtifactName: 'vrscreenshot${{ parameters.fluentVersion }}'
      publishLocation: 'Container'
