# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  batch: true
  branches:
    include:
      - master

variables:
  skipComponentGovernanceDetection: true

pool: '1ES-Host-Ubuntu'

jobs:
  - job: VRToolUpdateBaseline_V9
    workspace:
      clean: all
    steps:
      - template: .devops/templates/tools.yml

      - template: .devops/templates/runpublishvrscreenshot.yml
        parameters:
          fluentVersion: v9
          storyPackageName: '@fluentui/vr-tests-react-components'
          storyPackagePath: 'apps/vr-tests-react-components'
          shouldbuildstorybookaddon: true

      - bash: node node_modules/vrscreenshotdiff/lib/index.js release --clientType "fluentuiv9" --buildId $(Build.BuildId)
        displayName: 'Run Screenshotdiff update baseline'
        env:
          API_URL: $(System.CollectionUri)
          API_TOKEN: $(TEST_PAT)
          API_REPOSITORY: $(Build.Repository.Name)
          API_PROJECT: $(System.TeamProject)
          SCREENSHOT_ARTIFACT_FOLDER: vrscreenshotv9
          GITHUB_API_TOKEN: $(GITHUB_TEST_PAT)
          STORAGE_ACCOUNT_FLUENTUI: $(STORAGE-ACCOUNT-FLUENTUI)
          STORAGE_KEY_FLUENTUI: $(STORAGE-KEY-BLOB-FLUENTUI)
          BLOB_CONNECTION_STRING: $(BLOB-CONNECTION-STRING)
          VR_APPROVAL_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)

  - job: VRToolUpdateBaseline_V8
    workspace:
      clean: all
    steps:
      - template: .devops/templates/tools.yml

      - template: .devops/templates/runpublishvrscreenshot.yml
        parameters:
          fluentVersion: v8
          storyPackageName: '@fluentui/vr-tests'
          storyPackagePath: 'apps/vr-tests'
          shouldbuildstorybookaddon: false

      - bash: node node_modules/vrscreenshotdiff/lib/index.js release --clientType "fluentuiv8" --buildId $(Build.BuildId)
        displayName: 'Run Screenshotdiff update baseline'
        env:
          API_URL: $(System.CollectionUri)
          API_TOKEN: $(TEST_PAT)
          API_REPOSITORY: $(Build.Repository.Name)
          API_PROJECT: $(System.TeamProject)
          SCREENSHOT_ARTIFACT_FOLDER: vrscreenshotv8
          GITHUB_API_TOKEN: $(GITHUB_TEST_PAT)
          STORAGE_ACCOUNT_FLUENTUI: $(STORAGE-ACCOUNT-FLUENTUI)
          STORAGE_KEY_FLUENTUI: $(STORAGE-KEY-BLOB-FLUENTUI)
          BLOB_CONNECTION_STRING: $(BLOB-CONNECTION-STRING)
          VR_APPROVAL_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)
