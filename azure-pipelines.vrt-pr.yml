pr:
  - master

# There's a separate pipeline for CI which also uses this file, but with a trigger override in the UI
# https://dev.azure.com/uifabric/fabricpublic/_apps/hub/ms.vss-ciworkflow.build-ci-hub?_a=edit-build-definition&id=164&view=Tab_Triggers
trigger: none

variables:
  - ${{ if not(startsWith(variables['Build.SourceBranch'], 'refs/heads/')) }}:
      - name: sinceArg
        value: --since $(targetBranch)

  - template: .devops/templates/variables.yml

pool: '1ES-Host-Ubuntu'

jobs:
  - job: VisualRegressionTest_V9
    variables:
      pipelineId: '311'
      pipelineName: 'fluent-ui VRT Pipeline v9'

    workspace:
      clean: all
    steps:
      - checkout: self
        fetchDepth: 0

      - template: .devops/templates/tools.yml

      - template: download-vr-cli.yml

      - template: .devops/templates/runpublishvrscreenshot.yml
        parameters:
          fluentVersion: v9
          vrTestPackageName: '@fluentui/vr-tests-react-components'
          vrTestPackagePath: 'apps/vr-tests-react-components'

      - bash: vr-app run-diff --buildType release --clientType "FLUENTUI" --locationPrefix 'fluentuiv9' --locationPostfix 'vrscreenshotv9' --clientName "fluentuiv9" --buildId $(Build.BuildId) --screenshotsDirectory 'screenshots/'
        displayName: 'Run Screenshotdiff update baseline'
        env:
          API_URL: $(System.CollectionUri)
          API_TOKEN: $(fabric-public-pipeline-access-PAT)
          API_REPOSITORY: $(Build.Repository.Name)
          API_PROJECT: $(System.TeamProject)
          SCREENSHOT_ARTIFACT_FOLDER: vrscreenshotv9
          GITHUB_API_TOKEN: $(githubRepoStatusPAT)
          STORAGE_ACCOUNT_FLUENTUI: $(STORAGE-ACCOUNT-FLUENTUI)
          STORAGE_KEY_FLUENTUI: $(STORAGE-KEY-BLOB-FLUENTUI)
          BLOB_CONNECTION_STRING: $(BLOB-CONNECTION-STRING)
          VR_APPROVAL_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)
          VR_APP_API_URL: 'https://vrtestfunctionapp.azurewebsites.net/api/'

      - bash: |
          postPolicy="true";
          response=$(curl --request POST 'https://login.microsoftonline.com/72f988bf-86f1-41af-91ab-2d7cd011db47/oauth2/token' --header 'Content-Type: application/x-www-form-urlencoded' --data-urlencode 'grant_type=client_credentials' --data-urlencode 'client_id=288a69b6-760d-4c1f-ad6d-0183b5e5740f' --data-urlencode 'client_secret='${VR_APPROVAL_CLIENT_SECRET} )
            parsedResponse=${response/*"access_token"/}
            token=${parsedResponse:3:${#parsedResponse}-5}
            curl --location --request POST 'https://vrtestfunctionapp.azurewebsites.net/api/policyStateV2' \
            --header 'Authorization: Bearer '"$token" \
            --header 'Content-Type: application/json' \
            --data-raw '	{
            "organization": "uifabric",
            "projectName": "fabricpublic",
            "prId": $(System.PullRequest.PullRequestNumber),
            "commitId": "$(Build.SourceVersion)",
              "generate":true,
              "clientType":"FLUENTUIV9",
              "blockingPipeline":{
              },
              "nonBlockingPipeline":{
                "$(pipelineId)": {
                  "pipelineStatus": "PENDING",
                  "pipelineName": "E2E Tests-v9"
                }
              },
              "postPolicy": '${postPolicy}',
              "policyType": "OPTIONAL"
            }'
        displayName: 'Call policy State Api'
        env:
          VR_APPROVAL_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)
          VR_APPROVAL_HOST: $(VR_APPROVAL_HOST)

      - template: .devops/templates/runpublishvrscreenshot.yml
        parameters:
          fluentVersion: v9
          vrTestPackageName: '@fluentui/vr-tests-react-components'
          vrTestPackagePath: 'apps/vr-tests-react-components'

      - bash: vr-app run-diff --buildType pr --screenshotsDirectory ./screenshots/ --clientType "FLUENTUI" --ciDefinitionId 205 --groupName 'E2E Tests-v9' --locationPrefix 'fluentuiv9' --locationPostfix 'vrscreenshotv9' --pipelineId $(pipelineId) --clientName 'fluentuiv9' --threshold '0.04' --cumThreshold '4'
        displayName: 'Run fluentui-screenshotdiff'
        env:
          API_URL: $(System.CollectionUri)
          API_TOKEN: $(fabric-public-pipeline-access-PAT)
          API_REPOSITORY: $(Build.Repository.Name)
          API_PROJECT: $(System.TeamProject)
          SCREENSHOT_ARTIFACT_FOLDER: vrscreenshotv9
          GITHUB_API_TOKEN: $(githubRepoStatusPAT)
          STORAGE_ACCOUNT_FLUENTUI: $(STORAGE-ACCOUNT-FLUENTUI)
          STORAGE_KEY_FLUENTUI: $(STORAGE-KEY-BLOB-FLUENTUI)
          STORAGE_CONNECTION_STRING: $(BLOB-CONNECTION-STRING)
          #BLOB_CONNECTION_STRING: $(BLOB-CONNECTION-STRING)
          # VR_APPROVAL_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)
          GITHUB_REPO_OWNER: 'microsoft'
          GITHUB_REPO_NAME: 'fluentui'
          # VR_APPROVAL_HOST: $(VR_APPROVAL_HOST)
          # VR_APP_NAME: $(VR_APP_NAME)
          VR_APP_API_URL: 'https://vrtestfunctionapp.azurewebsites.net/api/'
          VR_APP_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)
          VR_APP_CLIENT_ID: '288a69b6-760d-4c1f-ad6d-0183b5e5740f'
        condition: eq(variables['vrTestSkip'], 'no')

  - job: VisualRegressionTest_V8
    variables:
      pipelineId: '312'
      pipelineName: 'fluent-ui VRT Pipeline v8'
    workspace:
      clean: all
    steps:
      - checkout: self
        fetchDepth: 0

      - template: .devops/templates/tools.yml

      - template: download-vr-cli.yml

      - bash: |
          postPolicy="true";
          response=$(curl --request POST 'https://login.microsoftonline.com/72f988bf-86f1-41af-91ab-2d7cd011db47/oauth2/token' --header 'Content-Type: application/x-www-form-urlencoded' --data-urlencode 'grant_type=client_credentials' --data-urlencode 'client_id=288a69b6-760d-4c1f-ad6d-0183b5e5740f' --data-urlencode 'client_secret='${VR_APPROVAL_CLIENT_SECRET} )
            parsedResponse=${response/*"access_token"/}
            token=${parsedResponse:3:${#parsedResponse}-5}
            curl --location --request POST 'https://vrtestfunctionapp.azurewebsites.net/api/policyStateV2' \
            --header 'Authorization: Bearer '"$token" \
            --header 'Content-Type: application/json' \
            --data-raw '	{
            "organization": "uifabric",
            "projectName": "fabricpublic",
            "prId": $(System.PullRequest.PullRequestNumber),
            "commitId": "$(Build.SourceVersion)",
              "generate":true,
              "clientType":"FLUENTUIV8",
              "blockingPipeline":{
              },
              "nonBlockingPipeline":{
                "$(pipelineId)": {
                  "pipelineStatus": "PENDING",
                  "pipelineName": "E2E Tests-v8"
                }
              },
              "postPolicy": '${postPolicy}',
              "policyType": "OPTIONAL"
            }'
        displayName: 'Call policy State Api'
        env:
          VR_APPROVAL_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)
          VR_APPROVAL_HOST: $(VR_APPROVAL_HOST)

      - template: .devops/templates/runpublishvrscreenshot.yml
        parameters:
          fluentVersion: v8
          vrTestPackageName: '@fluentui/vr-tests'
          vrTestPackagePath: 'apps/vr-tests'

      - bash: vr-app run-diff --screenshotsDirectory ./dist/screenshots --buildType pr --clientType "FLUENTUI" --ciDefinitionId 205 --groupName 'E2E Tests-v8' --locationPrefix 'fluentuiv8' --locationPostfix 'vrscreenshotv8' --pipelineId $(pipelineId)  --clientName 'fluentuiv8' --threshold '0.04' --cumThreshold '4'

        displayName: 'Run fluentui-screenshotdiff'
        env:
          API_URL: $(System.CollectionUri)
          API_TOKEN: $(fabric-public-pipeline-access-PAT)
          API_REPOSITORY: $(Build.Repository.Name)
          API_PROJECT: $(System.TeamProject)
          SCREENSHOT_ARTIFACT_FOLDER: vrscreenshotv8
          GITHUB_API_TOKEN: $(githubRepoStatusPAT)
          STORAGE_ACCOUNT_FLUENTUI: $(STORAGE-ACCOUNT-FLUENTUI)
          STORAGE_KEY_FLUENTUI: $(STORAGE-KEY-BLOB-FLUENTUI)
          # BLOB_CONNECTION_STRING: $(BLOB-CONNECTION-STRING)
          STORAGE_CONNECTION_STRING:  $(BLOB-CONNECTION-STRING)
          # VR_APPROVAL_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)
          GITHUB_REPO_OWNER: 'microsoft'
          GITHUB_REPO_NAME: 'fluentui'
          # VR_APPROVAL_HOST: $(VR_APPROVAL_HOST)
          # VR_APP_NAME: $(VR_APP_NAME)
          # VR_APP_API_URL: 'https://vrtestfunctionapp.azurewebsites.net/api/'
          VR_APP_API_URL: 'https://vrtestfunctionapp.azurewebsites.net/api/'
          VR_APP_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)
          VR_APP_CLIENT_ID: '288a69b6-760d-4c1f-ad6d-0183b5e5740f'
        condition: eq(variables['vrTestSkip'], 'no')

  - job: VisualRegressionTest_V0
    variables:
      pipelineId: '313'
      pipelineName: 'fluent-ui VRT Pipeline v0'

    workspace:
      clean: all
    steps:
      - checkout: self
        fetchDepth: 0

      - template: .devops/templates/tools.yml

      - template: download-vr-cli.yml

      - bash: |
          postPolicy="true";
          response=$(curl --request POST 'https://login.microsoftonline.com/72f988bf-86f1-41af-91ab-2d7cd011db47/oauth2/token' --header 'Content-Type: application/x-www-form-urlencoded' --data-urlencode 'grant_type=client_credentials' --data-urlencode 'client_id=288a69b6-760d-4c1f-ad6d-0183b5e5740f' --data-urlencode 'client_secret='${VR_APPROVAL_CLIENT_SECRET} )
            parsedResponse=${response/*"access_token"/}
            token=${parsedResponse:3:${#parsedResponse}-5}
            curl --location --request POST 'https://vrtestfunctionapp.azurewebsites.net/api/policyStateV2' \
            --header 'Authorization: Bearer '"$token" \
            --header 'Content-Type: application/json' \
            --data-raw '	{
            "organization": "uifabric",
            "projectName": "fabricpublic",
            "prId": $(System.PullRequest.PullRequestNumber),
            "commitId": "$(Build.SourceVersion)",
              "generate":true,
              "clientType":"FLUENTUIV0",
              "blockingPipeline":{
              },
              "nonBlockingPipeline":{
                "$(pipelineId)": {
                  "pipelineStatus": "PENDING",
                  "pipelineName": "E2E Tests-v0"
                }
              },
              "postPolicy": '${postPolicy}',
              "policyType": "OPTIONAL"
            }'
        displayName: 'Call policy State Api'
        env:
          VR_APPROVAL_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)

      - template: .devops/templates/runpublishvrscreenshot.yml
        parameters:
          fluentVersion: v0
          vrTestPackageName: '@fluentui/docs'
          vrTestPackagePath: 'packages/fluentui/docs'

      #
      # - bash: node node_modules/vrscreenshotdiff/lib/index.js pr --clientType "FluentUI-v0" --buildId $(Build.BuildId) --lkgCIBuild $(LatestBuildId) --pipelineId $(pipelineId) --pipelineName '$(pipelineName)' --locationPrefix 'fluentuiv0' --locationPostfix 'vrscreenshotv0'
      #   displayName: 'Run fluentui-screenshotdiff'
      #   env:
      #     API_URL: $(System.CollectionUri)
      #     API_TOKEN: $(fabric-public-pipeline-access-PAT)
      #     API_REPOSITORY: $(Build.Repository.Name)
      #     API_PROJECT: $(System.TeamProject)
      #     SCREENSHOT_ARTIFACT_FOLDER: vrscreenshotv0
      #     GITHUB_API_TOKEN: $(githubRepoStatusPAT)
      #     STORAGE_ACCOUNT_FLUENTUI: $(STORAGE-ACCOUNT-FLUENTUI)
      #     STORAGE_KEY_FLUENTUI: $(STORAGE-KEY-BLOB-FLUENTUI)
      #     BLOB_CONNECTION_STRING: $(BLOB-CONNECTION-STRING)
      #     VR_APPROVAL_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)
      #     GITHUB_REPO_OWNER: 'microsoft'
      #     GITHUB_REPO_NAME: 'fluentui'
      #     VR_APPROVAL_HOST: $(VR_APPROVAL_HOST)
      #     VR_APP_NAME: $(VR_APP_NAME)
      #   condition: eq(variables['vrTestSkip'], 'no')

      - bash: vr-app run-diff --buildType pr --screenshotsDirectory ./screenshots/ --clientType "FluentUI" --ciDefinitionId 205 --groupName 'E2E Tests-v0' --locationPrefix 'fluentuiv0' --locationPostfix 'vrscreenshotv0' --pipelineId $(pipelineId) --clientName 'FluentUIV0' --threshold '0.04' --cumThreshold '4'
        displayName: 'Run fluentui-screenshotdiff'
        env:
          API_URL: $(System.CollectionUri)
          API_TOKEN: $(fabric-public-pipeline-access-PAT)
          API_REPOSITORY: $(Build.Repository.Name)
          API_PROJECT: $(System.TeamProject)
          # SCREENSHOT_ARTIFACT_FOLDER: vrscreenshotv9
          GITHUB_API_TOKEN: $(githubRepoStatusPAT)
          STORAGE_ACCOUNT_FLUENTUI: $(STORAGE-ACCOUNT-FLUENTUI)
          STORAGE_KEY_FLUENTUI: $(STORAGE-KEY-BLOB-FLUENTUI)
          STORAGE_CONNECTION_STRING: $(BLOB-CONNECTION-STRING)
          #BLOB_CONNECTION_STRING: $(BLOB-CONNECTION-STRING)
          # VR_APPROVAL_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)
          GITHUB_REPO_OWNER: 'microsoft'
          GITHUB_REPO_NAME: 'fluentui'
          # VR_APPROVAL_HOST: $(VR_APPROVAL_HOST)
          # VR_APP_NAME: $(VR_APP_NAME)
          VR_APP_API_URL: 'https://vrtestfunctionapp.azurewebsites.net/api/'
          VR_APP_CLIENT_SECRET: $(VR-APPROVAL-CLIENT-SECRET)
          VR_APP_CLIENT_ID: '288a69b6-760d-4c1f-ad6d-0183b5e5740f'
        condition: eq(variables['vrTestSkip'], 'no')
