import { Meta } from '@storybook/addon-docs';
import { SSRDefaultOpen } from './MenuSSRDefaultOpen.stories';

<Meta title="Concepts/Developer/Server-Side Rendering/Basic Setup" />

## Server-Side Rendering

Fluent UI React v9 fully supports Server-Side Rendering.

### Basic setup

For any setup using SSR, you need to provide a `RendererProvider`, `SSRProvider` and `FluentProvider` in the root file of your app. If these providers are not added, there will be issues when hydrating. See the following example:

```tsx
import express from 'express';
import React from 'react';
import ReactDOMServer from 'react-dom/server';
import {
  createDOMRenderer,
  RendererProvider,
  renderToStyleElements,
  FluentProvider,
  teamsDarkTheme,
  SSRProvider,
} from '@fluentui/react-components';

const useExampleStyles = makeStyles({
  root: {
    color: 'red',
  },
});

const ExampleComponent: React.FC = () => {
  const classes = useExampleStyles();

  return <div className={classes.root}>Hello world</div>;
};

const server = express();

server.get('/', (req, res) => {
  const renderer = createDOMRenderer();

  const html = ReactDOMServer.renderToString(
    <RendererProvider renderer={renderer}>
      <SSRProvider>
        <FluentProvider theme={teamsDarkTheme}>
          <ExampleComponent />
        </FluentProvider>
      </SSRProvider>
    </RendererProvider>,
  );

  // Converting our styles to style elements and then rendering them to add them into our code.
  const style = ReactDOMServer.renderToStaticMarkup(<>{renderToStyleElements(renderer)}</>);

  res.write(`
  <!DOCTYPE html>
  <html>
    <head>
      ${style}
    </head>
    <body>
      <div id="root">${html}</div>
    </body>
  </html>
  `);
  res.end();
});

server.listen(3000, 'localhost');
```

### React Portals

React does not support hydration for portals ([facebook/react#13097](https://github.com/facebook/react/issues/13097)). While Fluent
UI tries to work out of the box without hydration warnings, some workarounds are required in certain edge cases.

#### Default open

Components like `Menu` or `Popover` have a `defaultOpen` prop that open the positioned surface on mount. These components
are rendered with React portals. In SSR using the `defaultOpen` on server render will cause a hydration error because
React does not support hydration for portals.

The below example shows how to use the `useIsSSR` hook to implement a `Menu` that is open by default on the first render.
Toggle the checkbox to mount/unmount the component.

<SSRDefaultOpen />

```tsx
import { Menu, MenuTrigger, MenuList, MenuItem, MenuPopover, useIsSSR, Button } from '@fluentui/react-components';
import * as React from 'react';

const DefaultOpenMenu = () => {
  const [open, setOpen] = React.useState(false);
  const isSSR = useIsSSR();

  React.useEffect(() => {
    if (!isSSR) {
      setOpen(true);
    }
  }, [isSSR]);

  return (
    <Menu open={open} onOpenChange={(e, data) => setOpen(data.open)}>
      <MenuTrigger>
        <Button>SSR Default open</Button>
      </MenuTrigger>

      <MenuPopover>
        <MenuList>
          <MenuItem>New </MenuItem>
          <MenuItem>New Window</MenuItem>
          <MenuItem disabled>Open File</MenuItem>
          <MenuItem>Open Folder</MenuItem>
        </MenuList>
      </MenuPopover>
    </Menu>
  );
};
```
