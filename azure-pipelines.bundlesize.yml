pr:
  - master
  - web-components-v3 # Remove before merging to master

trigger:
  - master
  - web-components-v3 # Remove before merging to master

variables:
  - ${{ if not(startsWith(variables['Build.SourceBranch'], 'refs/heads/')) }}:
      - name: sinceArg
        value: --since $(targetBranch)

  - template: .devops/templates/variables.yml

jobs:
  - job: bundlesize
    workspace:
      clean: all
    pool: '1ES-Host-Ubuntu'
    steps:
      - template: .devops/templates/tools.yml

      - task: Bash@3
        inputs:
          filePath: yarn-ci.sh
        displayName: yarn

      - script: |
          yarn lage bundle-size --verbose $(sinceArg)
        displayName: build packages & create reports

      - script: |
          yarn bundle-size compare-reports --branch=$(System.PullRequest.TargetBranch) --output=markdown --verbose
        displayName: compare bundle size with base (PR only)
        condition: eq(variables.isPR, true)

      - task: GithubPRComment@0
        displayName: Post results to PR (PR only)
        condition: eq(variables.isPR, true)
        inputs:
          githubOwner: microsoft
          githubRepo: 'fluentui'
          blobFilePath: 'packages/bundle-size/dist/bundle-size.md'
          status: 'success'
          uniqueId: 'bundleSizeComment9423'

      - script: |
          yarn bundle-size upload-report --branch=$(Build.SourceBranchName) --commit-sha $(Build.SourceVersion)
        displayName: upload a report (base only)
        condition: eq(variables.isPR, false)
        env:
          # https://docs.microsoft.com/en-us/azure/devops/pipelines/process/variables?view=azure-devops&tabs=yaml%2Cbatch#secret-variables
          BUNDLESIZE_ACCOUNT_KEY: $(bundlesize-account-key)

      - template: .devops/templates/cleanup.yml
