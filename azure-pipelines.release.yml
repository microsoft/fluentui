#################################################
# This branch no longer has scheduled releases. #
# If you need a release, trigger it manually.   #
#################################################

pr: none
trigger: none

# Customize build number to include major version
# Example: v5_20190626.1
name: 'v5_$(Date:yyyyMMdd)$(Rev:.r)'

variables:
  - group: 'Github and NPM secrets'

pool:
  vmImage: 'Ubuntu 20.04'

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "8.x"
    displayName: "Install Node.js"

  - script: |
      git config user.name "UI Fabric Build"
      git config user.email "fluentui-internal@service.microsoft.com"
      git remote set-url origin https://$(githubUser):$(githubPAT)@github.com/microsoft/fluentui.git
    displayName: Authenticate git for pushes

  - script: |
      npm install --ignore-scripts
      node node_modules/@microsoft/rush/bin/rush install --bypass-policy
    displayName: rush install

  - script: |
      npm run build
    displayName: rush build (Create production build)

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: apps/fabric-website/dist
      artifactName: "fabric-website"
      publishLocation: "Container"
    displayName: "Publish Artifact: Fabric Website"

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: packages/office-ui-fabric-react/dist
      artifactName: "fabric"
      publishLocation: "Container"
    displayName: "Publish Artifact: Fabric"

  - script: |
      node node_modules/@microsoft/rush/bin/rush publish -a -p -b 5.0 -t lts-5 -n $(npmToken) --add-commit-details
    displayName: "Publish Change Requests and Bump Versions"

  # create-site-manifests is a script defined in @fluentui/public-docsite-setup.
  # It generates manifest files used to load the current version on developer.microsoft.com/fluentui.
  #
  # TODO: The second argument can be removed once @fluentui/public-docsite-setup is updated to latest,
  # where URL specified will be the default. For now it's overridden here to avoid needing another
  # round of changes to pick up the package in every branch.
  - script: |
      npx create-site-manifests ../../packages/office-ui-fabric-react https://fabricweb.azureedge.net/fabric-website/v5/$(Build.BuildNumber)/
    workingDirectory: apps/fabric-website
    displayName: 'Generate website manifests'

  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: ./apps/fabric-website/site-manifests
      artifactName: 'fabric-website-manifests'
      publishLocation: 'Container'
    displayName: 'Publish Artifact: Website manifests'

  - script: |
      node scripts/updateReleaseNotes.js --token=$(githubPAT) --apply --debug
    displayName: "Update github release notes"

  - task: AzureArtifacts.manifest-generator-task.manifest-generator-task.ManifestGeneratorTask@0
    displayName: ðŸ“’ Generate Manifest
    inputs:
      BuildDropPath: $(System.DefaultWorkingDirectory)

  - task: PublishPipelineArtifact@1
    displayName: ðŸ“’ Publish Manifest
    inputs:
      artifactName: SBom-$(System.JobAttempt)
      targetPath: $(System.DefaultWorkingDirectory)/_manifest
